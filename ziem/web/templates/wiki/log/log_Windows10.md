![logo](/static/images/logo.png)

##  Настройка ОС Windows 
> Описание процесса настройки ОС Windows для отправки сообщений в ZIEM  
> Область применения:  
> -- Windows 10  
> -- Windows Server 2016, 2019  

## Содержание  

* [Описание](#menu_info)
* [Настройка Пользователя](#menu_user)
* [Настройка DCOM](#menu_dcom)
* [Настройка WMI](#menu_wmi)
* [Доступ по RDP](#menu_rdp)
* [Брандмауер](#menu_fw)
* [Политики аудита](#menu_audit)
* [Настройка Сети](#menu_net)  


> Для автоматизированной настройки можно исполнить [скрипт](/static/bat/log_windows10.bat) (с правами администратора).


<hr class="pagebreak">

<a name="menu_info"/>  

## Описание  
</a>  

> Получения журналов Windows происходит при помощи WMI 
> WMI в свою очередь использует протокол DCOM  
> На источнике необходимо создать `пользователя` для подключения  
> Предоставить ему `права` и настроить `Брандмауэр`  
> Также для генерации сообщений необходимо настроить `аудит`
> Необходимо перезагрузить АРМ в конце настройки  


<a name="menu_user"/>  

## Настройка Пользователя

</a>  

- Создаём пользователя `ziem_user`:

```cmd
net user ziem_user Asd45%qwerT /add
wmic useraccount where "name='ziem_user'" set passwordexpires=false
```

- Добавляем пользователя `ziem_user` в группы:

> Список групп можно посмотреть `net localgroup`

```cmd
net localgroup "Пользователи журналов производительности" ziem_user /add 
net localgroup "Читатели журнала событий" ziem_user /add 
net localgroup "Пользователи DCOM" ziem_user /add
```

или если названия групп англоязычные:

```cmd
net localgroup "Performance Log Users" ziem_user /add 
net localgroup "Event Log Readers" ziem_user /add 
net localgroup "Distributed COM Users" ziem_user /add
```
<hr class=pb>

- Делаем учетную запись технологической, без интерактивного входа  
-- запускаем `secpol.msc`  
-- выбираем `Локальные политики / Назначение прав пользователя`  
-- добавляем `ziem_user` в следующие списки  
*Запретить локальный вход*  
*Запретить вход в систему через службу удаленных рабочих столов*  
*Вход в качестве службы*  
*Доступ к компьютеру из сети*  

<a name="menu_dcom"/>  

## Настройка DCOM  
</a>  

- Запускаем `dcomcnfg`  
- Правый-щелчок `Службы компонентов \ Компьютеры \ Мой компьютер \ Настройка DCOM \ Windows Management and Instrumentation`, выбираем `свойства`   
- Выбираем вкладку `Безопасность`  
- В поле `Разрешения на запуск` нажимаем `Настроить \ Изменить`  
- Добавляем пользователя `ziem_user` c `разрешениями`  
-- *Удаленный запуск, Удаленная активация*  
- В поле `Разрешение на доступ` нажимаем `Настроить \ Изменить`  
- Добавляем пользователя `ziem_user` c `разрешениями`  
-- *Удаленный доступ*  

<a name="menu_wmi"/>  

## Настройка WMI  
</a>  

- Запускаем `wmimgmt.msc`  
- Правый-щелчок `Элемент управления WMI`, выбираем `свойства`  
- Вкладка `Безопасность`  
- Выбираем `CIMV2`, нажимаем `Безопасность`  
- Нажимаем `добавить`  
- Добавляем пользователя `ziem_user` c `разрешениями`  
-- *Выполнение методов, Включить учетную запись, Включить удаленно, Прочесть безопасность*  


<a name="menu_rdp"/> 

## Доступ по RDP
</a>

* В `Службы` проверить состояние `Службы удаленных рабочих столов`, она не должна быть отключена.

* В `Параметры удаленного рабочего стола` 
     - Включить `Удаленный рабочий стол`
     - В `Дополнительные настройки` включить: *Требовать использовать аутентификацию на уровне сети...*


* Отключение  **UAC**

> Контроль учётных записей пользователей (англ. User Account Control, UAC). Этот компонент запрашивает подтверждение действий, требующих прав администратора, в целях защиты от несанкционированного использования компьютера. 

-- `Параметры управления учетными записями` выставить второй уровень: 
Уведомлять только при попытках приложений внести изменения в компьютер (не затемнять рабочий стол)*

-- или в терминале от имени администратора выполнить команды:

```cmd
REG ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /t REG_DWORD /d 1 /f
REG ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v ConsentPromptBehaviorAdmin /t REG_DWORD /d 5 /f
REG ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v PromptOnSecureDesktop /t REG_DWORD /d 0 /f
```

<hr class="pagebreak">

<a name="menu_fw"/>  

## Брандмауер
</a>  

- Добавляем правила для WMI:

```cmd
netsh advfirewall firewall add rule ^
 name="ZIEM-RPC-135" dir=in action=allow ^
 protocol=TCP localport=135 ^
 remoteip=172.30.1.4,172.30.2.4,172.30.1.5,172.30.2.5 ^
 program="%SystemRoot%\system32\svchost.exe" enable=yes
netsh advfirewall firewall add rule ^
 name="ZIEM-RPC-dynamic" dir=in action=allow ^
 protocol=TCP localport=RPC ^
 remoteip=172.30.1.4,172.30.2.4,172.30.1.5,172.30.2.5 ^
 program="%SystemRoot%\system32\svchost.exe" enable=yes
```

- Добавляем правила для RDP:

```cmd
netsh advfirewall firewall add rule ^
 name="RDP TSPD2" dir=in action=allow ^
 protocol=TCP localport=3389 ^
 remoteip=172.30.1.6,172.30.2.6
```

<a name="menu_audit"/>  

## Политика аудита
</a>  

* запускаем `secpol.msc`
* выбираем Конфигурация расширенной политики аудита 
* добавляем:
    - Вход учетной записи/аудит проверки учетных данных Успех
    - Управление учетными записями/Аудит других событий управления учетными записями Успех и отказ
    - Подробное отслеживание/PNP-действие аудита Успех
    - Доступ к объектам/Аудит общего файлового ресурса Успех
    - Доступ к объектам/Аудит других событий доступа к объектам Успех
    - Изменение политики/Аудит изменения политики на уровне правил MPSSVC Успех
    - Система/Аудит других системных событий Успех


<a name="menu_net"/>  

## Настройка сети  
</a>  

- Настройка сети/добавить маршруты для сервера ИБ

```cmd
route add -p 172.30.1.0 mask 255.255.255.240 192.168.Х.Х
route add -p 172.30.2.0 mask 255.255.255.240 192.168.Х.Х
```

- Настройка сети/добавить маршруты для ARM admin TSPD

```cmd
route add -p 172.31.254.21 mask 255.255.255.255 192.168.Х.Х
```

- Настройка сети/добавить маршруты для FileSendera

```cmd
route add -p 172.29.1.29 mask 255.255.255.255 192.168.Х.Х
```